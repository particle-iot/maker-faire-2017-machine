<!DOCTYPE html>

<html>

<body>
<h1>It's alive!</h1>
<pre id="raw-data"></pre>

<script>
var count = 0;
function loadData() {
  var headers = new Headers();
  headers.append('pragma', 'no-cache');
  headers.append('cache-control', 'no-cache');
  var request = new Request('data.json', {
    headers: headers,
    cache: 'no-store'
  });

  return Promise.race([fetch(request), timeout(100)]).then(function (response) {
    return response.text();
  }).then(function (data) {
    updateData(data);
  }).then(reloadDataAfterInterval).catch(reloadDataAfterInterval);
}

function updateData(data) {
  count += 1;
  var el = document.getElementById('raw-data');
  if (el) {
    el.innerText = count + '\n' + data;
  }
}

function reloadDataAfterInterval() {
  return delay(250).then(function () {
    return loadData();
  });
}

function delay(milliseconds) {
  return new Promise(function (resolve) {
    setTimeout(resolve, milliseconds);
  });
}

function timeout(milliseconds) {
  return new Promise(function (resolve, reject) {
    setTimeout(reject, milliseconds);
  });
}

loadData();

</script>

</body>
</html>
